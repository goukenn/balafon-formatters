<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Test Formatter</title>
        <!-- <script src="./dist/bformatter.js"></script> -->

        <script type="module" language="javascript">
        // use as global object . configured with webpack module
        import * as lib from './dist/bformatter/1.0.1/bformatter.mjs'; 
        (function(lib, t){ 
        const { Formatters } = lib; 
        const _formatter = Formatters.CreateFrom({
            scopeName:'scope.litteralString',
            patterns:[
                {
                    include:"#string",
                },{
                    include:"#reserved-word"
                
                },{
                    include:"#import-word"
                },
                {
                    include:"#end-instruction"
                },
                {
                    include:"#constant-value"
                },
                {
                    "begin":"\\{",
                    "end":"\\}",
                    "name":"block",
                    "isBlock":true, 
                    patterns:[
                        {include:"#end-instruction"},
                        {
                            include:"#string"
                        }
                    ]
                },
            ],
            repository:{
                string:{
                    "begin":"\"",
                    "end":"\"",
                    "name":"constant.string.litteral",
                    "tokenID":"string"
                },
                "reserved-word":{
                    "match":"\\b(var|else|true|false|let|const|if|while|do|return|exec|finally|catch|in|for)\\b",
                    "end":"\"",
                    "name":"constant.litteral",
                    "tokenID":"reserved-word"
                },
                "constant-value":{
                    "match":"\\b(true|false|pi)\\b",
                    "end":"\"",
                    "name":"constant.litteral",
                    "tokenID":"reserved-word"
                },
                "import-word":{
                    "match":"\\b(import|as|from)\\b",
                    "name":"constant.litteral",
                    "tokenID":"yield-word"
                },
                "end-instruction":{
                    "match":"(;)",
                    "name":"operator.end.instrution",
                    "lineFeed":true
                }
            },
            engine:"html-listener"
        }); 
        _formatter.debug = true;
        _formatter.listener = ()=>( function(){
            let node = null;
            let blocks = [];
            return {
            renderToken(v, tokens, tokenID, engine){
                let lt = tokens.shift();
                let n = null;
                if (tokenID){
                    switch(tokenID){
                        case 'string':
                            n = document.createElement('span');
                            n.style = 'color:red;';
                            n.innerHTML = v;
                            return n.outerHTML;
                        case 'reserved-word':
                            n = document.createElement('span');
                            n.style = 'color:skyblue;';
                            n.innerHTML = v;
                            return n.outerHTML;
                    }
                }
                // console.log('render token: ', lt , " : ", v);
                return v;
            },
            store({output, buffer}){
                // console.log("store : ", buffer, output);
                
                let d = document.createElement('div');
                d.innerHTML = buffer;
                output.push(d.outerHTML);
            },
            appendLine(lineFeed, bufferOutput, { store }){
                // bufferOutput.appendToBuffer("<br />");
                store();
            },
            startNewBlock(){
                //console.log(arguments);
                node = document.createElement('n');
                node.className = 'block - ';

                return;
            }  
        }
        })();
        // console.log(_formatter.listener);

        t.innerHTML = _formatter.format([
            // "var info = \"du jour\";",
            "if (true) { return \"ok data\"; }", 
            //" else return x; "
        ]);
    })(lib, document.getElementById('content'));
    </script>
    </head>
    <body>
        <h1>Test formatter online</h1>
        <code id="content"></code>
    </body>
</html>